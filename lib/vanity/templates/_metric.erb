<h3><%=h Vanity::Metric.name(id, metric) %></h3>
<%= Vanity::Metric.description(metric).to_s.split(/\n\s*\n/).map { |para| %{<p class="description">#{h para}</p>} }.join %>
<div class="chart"></div>
<script id="source" language="javascript" type="text/javascript">
$(function () {
    <% today = Date.today ; dates = today - 90..today ; values = metric.values(dates.first, dates.last) ; lines = dates.zip(values) ; js = lines.map { |date,value| "[#{date.to_time.to_i * 1000},#{value}]" }.join(",")  %>
    var lines = [{ label: "<%=h Vanity::Metric.name(id, metric) %>", data: [<%= js %>] }];
    var chart = $("#metric<%= id %> .chart");
    chart.height(chart.width() / 10);
    var markings = [];
    var options = {
      xaxis: { mode: "time", minTickSize: [7, "day"] }, yaxis: { ticks: 1 },
      series: { lines: { show: true, lineWidth: 2, fill: true, fillColor: { colors: ["#FFF", "#C6D2DA"] } }, points: { show: true, radius: 0 }, shadowSize: 0 },
      colors: ["#0077CC"],
      legend: { position: 'sw', container: "#metric<%= metric.id %> .legend", backgroundOpacity: 0.5 },
      grid: { markings: markings, borderWidth: 0 } };
    var plot = $.plot(chart, lines, options);
    jQuery.each(markings, function(i, mark) { 
      $('<div style="position:absolute;top:5%;color:#f02020;font-size:smaller"></div>').
        css({left:plot.pointOffset({x:mark.xaxis.from}).left+4}).text(mark.text).appendTo(chart);
    });
});
</script>
