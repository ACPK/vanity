<!DOCTYPE html>
<html>
  <head>
    <title>Vanity &mdash; Using with Rails</title>
    <link href="css/page.css" media="screen,print" rel="stylesheet" type="text/css">
    <link href="css/print.css" media="print" rel="stylesheet" type="text/css">
    <link href="images/favicon.png" rel="shortcut icon">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
    <script type="text/javascript" src="site.js"></script>
  </head>
  <body>
    <div id="header">
      <div class="title"><a href="http://vanity.labnotes.org" title="Mirror, mirror, on the wall &hellip;">Vanity</a></div>
      <div class="tagline">Experiment<br>Driven Development</div>
    </div>
    <div id="links">
      <a href="http://github.com/assaf/vanity">Source code</a> |
      <a href="http://groups.google.com/group/vanity-talk" title="vanity-talk google group">Google Group</a> |
      <a href="http://rdoc.info/gems/vanity">API reference</a>
    </div>
    <div id="sidebar">
      <ul>
        <li><a href="index.html#intro" title="A/B Testing with Rails">Intro</a></li>
        <li><a href="metrics.html">Metrics</a></li>
        <li><a href="ab_testing.html" title="Everything you need to know">A/B Testing</a></li>
        <li><a href="rails.html">Using with Rails</a></li>
        <li><a href="email.html">Testing emails</a></li>
        <li><a href="identity.html">Managing Identity</a></li>
        <li><a href="configuring.html">Configuring</a></li>
        <li><a href="contributing.html">Contributing</a></li>
        <li><a href="experimental.html">Experimental</a></li>
      </ul>
      <ul id="stats">
        <li><a href="http://travis-ci.org/assaf/vanity"><img src="http://travis-ci.org/assaf/vanity.png"></a></li>
        <li><a href="http://wiki.github.com/assaf/vanity/whos-using-vanity">Who's using it?</a></li>
      </ul>
    </div>
    <div id="content">
      <h1 id="using with rails">Using with Rails</h1>
      <div id="toc">
<ol>
	<li><a href="#install">Installing Vanity</a></li>
	<li><a href="#config">Configuring Vanity</a></li>
	<li><a href="#test">Test Environment</a></li>
	<li><a href="#dashboard">Dashboard</a></li>
	<li><a href="#fork">Unicorn and Forking Servers</a><br />
</div></li>
</ol>
<h3 id="install">Installing Vanity</h3>
<p><em>Rails 3.x and 4.x:</em></p>
<p>Add Vanity to your Gemfile:</p>
<pre>
gem "vanity"
</pre>
<p><em>Rails 2.x:</em></p>
<pre>
Rails::Initializer.run do |config|
  gem.config "vanity"

  config.after_initialize do
    require "vanity"
  end
end
</pre>
<h3 id="config">Configuring Vanity</h3>
<h4>Configuring identity</h4>
<p>Once the gem is setup, enable Vanity in your ActionController:</p>
<pre>
class ApplicationController &lt; ActionController::Base
  use_vanity :current_user
end
</pre>
<p>This example assumes you have a <code>current_user</code> controller method which will return a consistent value for each user. <br />
There are other ways to identify people as well, you can read more about the options in Managing Identity.</p>
<h4>Configuring datastore</h4>
<p>If you have a <code>config/vanity.yml</code> file, Vanity will read the configuration for the current environment.  For example:</p>
<pre>
staging:
  adapter: redis
  host: staging.internal
production:
  adapter: mongo
  host: live.internal
  database: vanity
</pre>
<h4>Using metrics from Google Analytics</h4>
<p>If you want to use Vanity with metrics from Google Analytics, you must also tell Rails to include the <code>garb</code> gem, and login for a new session.  You&#8217;ll want to do that for production, not for development if you like developing offline:</p>
<pre>
config.after_initialize do
  require "garb"
  Garb::Session.login('..ga email..', '..ga pwd..', account_type: "GOOGLE")
end
</pre>
<h4>Enabling experiments outside of the production environment</h4>
<p>There&#8217;s generally no need to collect metric and experiment data outside production environment.  Under Rails, Vanity turns collection on only if the environment name is &#8220;production&#8221;. You can control this from <code>config/environments</code> by setting <code>Vanity.playground.collecting</code> to true/false. When collection is off, Vanity doesn&#8217;t connect to the database server, so there&#8217;s no need to set a database configuration for these environments.</p>
<h3 id="dashboard">Dashboard</h3>
<p>Start by adding a new resource in <code>config/routes.rb</code>:</p>
<pre>
map.vanity "/vanity/:action/:id", :controller=&gt;:vanity
</pre>
<p>Create a new controller for Vanity:</p>
<pre>
class VanityController &lt; ApplicationController
include Vanity::Rails::Dashboard
end
</pre>
<p>Now open your browser to <a href="http://localhost:3000/vanity">http://localhost:3000/vanity</a>.</p>
<p>The Dashboard renders complete <span class="caps">HTML</span> pages with <span class="caps">CSS</span> and all necessary JavaScript libraries.  Thankfully, <span class="caps">HTML</span> is forgiving enough that it will render correctly even with your existing application layout.  You can decide to keep your layout, or tell the controller to set <code>layout false</code>.</p>
<h3 id="fork">Unicorn and Forking Servers</h3>
<p>Unicorn forks the master process to create worker processes efficiently.  Since the master processes opens a connection to the database, all workers end up sharing that connection, resulting in ugly contention issues.</p>
<p>The cure is simple, use the <code>after_fork</code> hook to reconnect each worker process.  Here&#8217;s the relevant part from my <code>config/unicorn.rb</code>:</p>
<pre>
after_fork do |server, worker|
  ActiveRecord::Base.establish_connection
  Vanity.playground.establish_connection
end
</pre>
<p>You&#8217;ll run into this issue with other forking servers.  Vanity can detect when it runs under Passenger and automatically reconnect each forked process.</p>
    </div>
    <div id="footer"><a href="credits.html">Credits / License</a></div>
    <script type="text/javascript">var _gaq=_gaq||[];_gaq.push(["_setAccount", "UA-1828623-6"], ["_trackPageview"]);(function(){var ga=document.createElement("script");ga.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";ga.setAttribute("async", "true");document.documentElement.firstChild.appendChild(ga);})();</script>
  </body>
</html>
