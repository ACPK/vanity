<!DOCTYPE html>
<html>
  <head>
    <title>Vanity &mdash; Using with Rails</title>
    <link href="css/page.css" media="screen,print" rel="stylesheet" type="text/css">
    <link href="css/print.css" media="print" rel="stylesheet" type="text/css">
    <link href="images/favicon.png" rel="shortcut icon">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
    <script type="text/javascript" src="site.js"></script>
  </head>
  <body>
    <div id="header">
      <div class="title"><a href="http://vanity.labnotes.org" title="Mirror, mirror, on the wall &hellip;">Vanity</a></div>
      <div class="tagline">Experiment<br>Driven Development</div>
    </div>
    <div id="links">
      <a href="http://github.com/assaf/vanity">Source code</a> |
      <a href="http://stackoverflow.com/questions/tagged/vanity" title="stackoverflow vanity tag">StackOverflow Tag</a> |
      <a href="http://rdoc.info/gems/vanity">API reference</a>
    </div>
    <div id="sidebar">
      <ul>
        <li><a href="index.html#intro" title="A/B Testing with Rails">Intro</a></li>
        <li><a href="metrics.html">Metrics</a></li>
        <li><a href="ab_testing.html" title="Everything you need to know">A/B Testing</a></li>
        <li><a href="rails.html">Using with Rails</a></li>
        <li><a href="email.html">Testing emails</a></li>
        <li><a href="identity.html">Managing Identity</a></li>
        <li><a href="configuring.html">Configuring</a></li>
        <li><a href="contributing.html">Contributing</a></li>
        <li><a href="experimental.html">Experimental</a></li>
      </ul>
      <ul id="stats">
        <li><a href="http://travis-ci.org/assaf/vanity"><img src="https://api.travis-ci.org/assaf/vanity.png?branch=master"></a></li>
        <li><a href="http://wiki.github.com/assaf/vanity/whos-using-vanity">Who's using it?</a></li>
      </ul>
    </div>
    <div id="content">
      <h1 id="using with rails">Using with Rails</h1>
      <div id="toc">
<ol>
	<li><a href="#install">Installing Vanity</a></li>
	<li><a href="#config">Configuring Vanity</a></li>
	<li><a href="#test">Test Environment</a></li>
	<li><a href="#fork">Unicorn and Forking Servers</a><br />
</div></li>
</ol>
<h3 id="install">Installing Vanity</h3>
<p><em>Rails 3.x and 4.x:</em></p>
<p>Add Vanity to your Gemfile:</p>
<pre>
gem "vanity"
</pre>
<h3 id="config">Configuring Vanity</h3>
<h4>Configuring identity</h4>
<p>Once the gem is setup, enable Vanity in your ActionController:</p>
<pre>
class ApplicationController &lt; ActionController::Base
  use_vanity :current_user
end
</pre>
<p>This example assumes you have a <code>current_user</code> controller method which will return a consistent value for each user.<br />
There are other ways to identify people as well, you can read more about the options in Managing Identity.</p>
<h4>Enabling/disable collection</h4>
<p>When collection is off, Vanity doesn&#8217;t connect to the database server, so there&#8217;s no need to set a database configuration for these environments.</p>
<h4>Overriding default views</h4>
<p>If you would like to customize Vanity&#8217;s dashboard, you can create create copies of the default views in <code>app/views/vanity</code> by running a generator:</p>
<pre>
rails g vanity:views
</pre>
<p>You can then edit them to your heart&#8217;s content. If you need to use an alternative location for your custom templates, set the configuration variable <code>custom_templates_path</code> on <code>Vanity.playground</code> like this:</p>
<pre>
Vanity.configure do |config|
  config.templates_path = 'views/vanity'
end
</pre>
<h3 id="fork">Unicorn and Forking Servers</h3>
<p>Unicorn forks the master process to create worker processes efficiently.  Since the master processes opens a connection to the database, all workers end up sharing that connection, resulting in ugly contention issues.</p>
<p>The cure is simple, use the <code>after_fork</code> hook to reconnect each worker process.  Here&#8217;s the relevant part from my <code>config/unicorn.rb</code>:</p>
<pre>
after_fork do |server, worker|
  ActiveRecord::Base.establish_connection
  Vanity.playground.establish_connection
end
</pre>
<p>You&#8217;ll run into this issue with other forking servers like Passenger as well.</p>
    </div>
    <div id="footer"><a href="credits.html">Credits / License</a></div>
    <script type="text/javascript">var _gaq=_gaq||[];_gaq.push(["_setAccount", "UA-1828623-6"], ["_trackPageview"]);(function(){var ga=document.createElement("script");ga.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";ga.setAttribute("async", "true");document.documentElement.firstChild.appendChild(ga);})();</script>
  </body>
</html>
